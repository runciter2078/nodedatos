name: Newsletter semanal nodedatos

on:
  schedule:
    - cron: '0 8 * * MON'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-newsletter:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install xai-sdk

      - name: Paso 1 - Ingestar RSS
        run: python scripts/01_ingest_rss.py

      - name: Paso 2 - Ingestar X
        env:
          XAI_API_KEY: ${{ secrets.XAI_API_KEY }}
        run: python scripts/02_ingest_x.py

      - name: Paso 3 - Procesar contenido
        run: python scripts/03_process.py

      - name: Paso 4 - Generar y revisar newsletter
        env:
          XAI_API_KEY: ${{ secrets.XAI_API_KEY }}
        run: python scripts/04_generate.py

      - name: Paso 5 - Publicar en web
        run: python scripts/05_publish_web.py

      - name: Paso 6 - Enviar borrador a Buttondown
        env:
          BUTTONDOWN_API_KEY: ${{ secrets.BUTTONDOWN_API_KEY }}
        run: python scripts/06_send_email.py

      - name: Paso 7 - Generar tweets
        env:
          XAI_API_KEY: ${{ secrets.XAI_API_KEY }}
        run: python scripts/07_generate_tweets.py

      - name: Paso 8 - Guardar tweets como artifact
        uses: actions/upload-artifact@v4
        with:
          name: tweets-semanales
          path: data/output/tweets_*.txt
          retention-days: 30

      - name: Paso 9 - Guardar borrador pre-revision como artifact
        uses: actions/upload-artifact@v4
        with:
          name: newsletter-borrador
          path: data/output/newsletter_*_borrador.md
          retention-days: 14

      - name: Commit newsletter a la web
        run: |
          git config user.name "nodedatos Bot"
          git config user.email "bot@nodedatos.es"
          git add web/content/newsletter/
          git diff --staged --quiet || git commit -m "Newsletter semanal automatica"
          git push
